# 关于 Korok

Korok 取自塞尔达传说里面的森林精灵，在我的最初计划里面这应该是一个面向组件的简单易扩展的2D游戏引擎，引擎的设计启发自：bitsquid.blogspot.com 。
在一般的游戏引擎中都会有游戏对象的概念，比如：Unity 的 GameObject，Cocos2D 的 Sprite，在 korok 里面，是没有这个概念的，它的本质是一个ECS系统，GameObject
是通过一个 id索引各种相关组件组成的，现在设计了几种组件：

1. RenderComp 渲染一个可渲染对象
2. Transform  负责坐标和场景图
3. Animator   动画控制器
3. SourceComp 负责音频

--七夕的第二天

操千曲而后晓声，观千剑而后识器。在之前的设计中，渲染引擎的基础架构设计的不够好，导致后面的系统集成变得艰难。在阅读了大量的开源游戏引擎的渲染系统代码之后，对基础图形API接口的设计
有了新的想法。这样的API符合的特征是：

1. 无状态渲染提交(stateless)
2. 基于排序渲染(sort-based)
3. 易于实现多线程(multi-thread)
4. 兼容新的图形API

这部分的底层API，实现在 `gfx/bk` 叫做 'bk-api'。目前版本的实现搭建了基本的API框架，排序，多线程等暂时都没有实现。但是架构在此，以后添加上这些并非难事。
从现在的观点看来，这种API设计是比较主流的底层图形API设计方式，Ogre3D/Paradox/BitSquid 等大型3D开源引擎都采用了这种设计，此处的设计借鉴了 bgfx 的实现，可以说
是一个简版的 bgfx，但是移除了 bgfx 里面大量的资源管理功能。


--国庆的第二天

基于 bk-API，分别实现了一个用于渲染简单网格的 MeshRender 和 一个用于批量精灵纹理渲染的 BatchRender。Korok 的 Batch 系统，底层维护了8个VBO，最多可以生成128个Batch分组。
Batch接口采用了一个半自动的方案：提供一个 batch-id 字段，如果用户把一组图元标记为相同的 batch-id，那么他们可能会被batch在一起。还有另外两种常见方案：

1. 使用 SpriteBatch 提供手动的 Batch 接口
2. 引擎检测材质，自动根据不同材质进行合并

第一种略显过时，第二种常常会造成困扰，比如我们认为应该batch的场景却没有batch。而korok中采用半自动的方案，可以在无法batch时做出相应的提示，并且尽量按照用户希望
的方式batch，或许能提供更好的开发体验。

--2017/10/06

音频系统暂时可以工作了，这部分api实现在 `audio/ap` 叫做 'ap-API'。这是一套非常底层的API具体负责：

1. 统一的资源管理
2. 播放优先级决策

音频格式(编解码)的支持在 `audio/xx` 目录下实现，这里有两个已经支持的音频格式:wav 和 ogg. wav 一般用来测试和播放占用内存较少的音效，ogg 用来播放背景音乐之类。
此处并不打算支持 mp3 格式，相较来说无论文件大小还是保真程度 ogg 都是优于 mp3 的，所以应该尽量用 ogg 格式来编码游戏音频。编解码模块和底层音频播放系统是完全分离的，
我们通过上层 API 来配置音频的编解码，相互之间通过接口依赖，这样方便以后添加更多音频格式支持。

音频管理（内存管理）和播放部分还有一些功能没有实现(TODO)。

--2017/10/14



